# rhino-cli

**RHINO** – Repository Hygiene & INtegration Orchestrator

Command-line tools for repository management and automation.

## What is rhino-cli?

A Go-based CLI tool that provides utilities for repository management and automation tasks. Built with Cobra CLI framework for powerful command-line interfaces.

## Quick Start

```bash
# Check all required development tools are installed
rhino-cli doctor

# Validate Claude Code format
rhino-cli validate-claude

# Sync Claude Code → OpenCode configurations
rhino-cli sync-agents

# Validate sync is correct
rhino-cli validate-sync

# Validate markdown links in the repository
rhino-cli validate-links

# Validate only staged files (useful in git hooks)
rhino-cli validate-links --staged-only

# Echo a message
rhino-cli --say "hello world"

# Verbose output with timestamps
rhino-cli --say "hello" --verbose

# Quiet mode (errors only)
rhino-cli --say "hello" --quiet
```

## Installation

Build the CLI tool from the repository root:

```bash
cd apps/rhino-cli
go build -o dist/rhino-cli
```

The binary will be created at `apps/rhino-cli/dist/rhino-cli`.

## Global Flags

### Say Flag

Echo a message to standard output.

```bash
# Basic usage
rhino-cli --say "hello world"

# Verbose output with timestamps
rhino-cli --say "hello" --verbose

# Quiet mode
rhino-cli --say "hello" --quiet

# Custom output format
rhino-cli --say "hello" -o json
```

**What it does:**

- Prints the provided message to stdout
- Supports verbose mode with timestamps
- Supports quiet mode for minimal output
- Handles special characters (quotes, newlines, tabs, etc.)

**Global Flags:**

- `--say` - Echo a message to stdout
- `--verbose, -v` - Verbose output with timestamps
- `--quiet, -q` - Quiet mode (errors only)
- `--output, -o` - Output format: text, json, markdown
- `--no-color` - Disable colored output

## Commands

### validate-links

Validate markdown links in the repository. Scans markdown files for broken internal links and generates a categorized report.

```bash
# Validate all markdown files
rhino-cli validate-links

# Validate only staged files (useful in pre-commit hooks)
rhino-cli validate-links --staged-only

# Output as JSON
rhino-cli validate-links -o json

# Output as markdown report
rhino-cli validate-links -o markdown

# Verbose mode
rhino-cli validate-links -v

# Quiet mode (errors only)
rhino-cli validate-links -q
```

**What it does:**

- Scans markdown files in core directories (docs/, governance/, .claude/, and root)
- Validates that all internal links point to existing files
- Automatically skips external URLs (http://, https://)
- Automatically skips Hugo paths (starting with /)
- Automatically skips placeholder links (path.md, target, etc.)
- Automatically skips example patterns (tu**\*, ex**\*, etc.)
- Categorizes broken links for easier fixing
- Supports multiple output formats (text, json, markdown)

**Flags:**

- `--staged-only` - Only validate staged files from git
- `-o, --output` - Output format: text, json, markdown (default: text)
- `-v, --verbose` - Verbose output with timestamps
- `-q, --quiet` - Quiet mode (errors only)

**Exit codes:**

- `0` - All links valid
- `1` - Broken links found

**Output categories:**

1. **Old ex-ru-\* prefixes** - Links containing `ex-ru-` or `ex__ru__`
2. **Missing files** - Common files like CODE_OF_CONDUCT.md, CHANGELOG.md
3. **General/other paths** - All other broken links
4. **workflows/ paths** - Links to workflows/ (not governance/workflows/)
5. **vision/ paths** - Links to vision/ (not governance/vision/)
6. **conventions README** - Links to conventions/README.md

**Example output (text):**

```
# Broken Links Report

**Total broken links**: 3

## General/other paths (3 links)

### docs/file.md

- Line 10: `../missing.md`
- Line 20: `./another-missing.md`

### README.md

- Line 5: `./nonexistent.md`
```

**Example output (JSON):**

```json
{
  "status": "failure",
  "timestamp": "2026-01-21T15:30:00+07:00",
  "total_files": 350,
  "total_links": 3920,
  "broken_count": 3,
  "duration_ms": 234,
  "categories": {
    "General/other paths": [
      {
        "source_file": "docs/file.md",
        "line_number": 10,
        "link_text": "../missing.md",
        "target_path": "/path/to/missing.md"
      }
    ]
  }
}
```

**Replaces:**

This command replaces the Python script at `scripts/validate-links.py` with a faster, more maintainable Go implementation.

### sync-agents

Sync Claude Code agents and skills to OpenCode format. Converts `.claude/` configuration to `.opencode/` format with proper YAML frontmatter transformation.

```bash
# Sync all agents and skills
rhino-cli sync-agents

# Preview changes without modifying files
rhino-cli sync-agents --dry-run

# Sync only agents (skip skills)
rhino-cli sync-agents --agents-only

# Sync only skills (skip agents)
rhino-cli sync-agents --skills-only

# Output as JSON
rhino-cli sync-agents -o json

# Verbose mode
rhino-cli sync-agents -v
```

**What it does:**

**Agents (`.claude/agents/` → `.opencode/agent/`):**

- Converts tools array to boolean map (`Read, Write` → `read: true, write: true`)
- Maps models (`sonnet`/`opus` → `zai/glm-4.7`, `haiku` → `zai/glm-4.5-air`, empty → `inherit`)
- Removes Claude-specific fields (`name`, `color`)
- Preserves description, skills, and body content
- Normalizes YAML formatting (adds spaces after colons)

**Skills (`.claude/skills/` → `.opencode/skill/`):**

- Direct byte-for-byte copy (formats are identical)
- Converts `SKILL.md` → `{skill-name}.md`

**Performance:** ~25-60x faster than bash scripts (121ms vs 3-5 seconds)

**Flags:**

- `--dry-run` - Preview changes without modifying files
- `--agents-only` - Sync only agents (skip skills)
- `--skills-only` - Sync only skills (skip agents)
- `-o, --output` - Output format: text, json, markdown (default: text)
- `-v, --verbose` - Verbose output with timestamps
- `-q, --quiet` - Quiet mode (errors only)

**Exit codes:**

- `0` - All conversions successful
- `1` - One or more conversions failed

**Replaces:**

This command replaces the bash scripts `scripts/sync-claude-to-opencode.sh` and `scripts/validate-sync.sh` with a faster, more robust Go implementation.

### validate-sync

Validate that `.claude/` and `.opencode/` configurations are semantically equivalent.

```bash
# Validate sync
rhino-cli validate-sync

# Output as JSON
rhino-cli validate-sync -o json

# Verbose mode (show all checks)
rhino-cli validate-sync -v

# Quiet mode (show only summary)
rhino-cli validate-sync -q
```

**What it does:**

**Agent Validation:**

- Count check: Ensures equal number of agents in both directories
- Equivalence check for each agent:
  - Description matches exactly
  - Model correctly converted (empty/sonnet/opus → inherit/zai/glm-4.7)
  - Tools correctly mapped (array → boolean map, lowercase)
  - Skills array matches exactly
  - Body content identical

**Skill Validation:**

- Count check: Ensures equal number of skills in both directories
- Identity check: Validates skills are byte-for-byte identical

**Flags:**

- `-o, --output` - Output format: text, json, markdown (default: text)
- `-v, --verbose` - Show all checks (default: show only failures)
- `-q, --quiet` - Quiet mode (show only summary)

**Exit codes:**

- `0` - All validation checks passed
- `1` - One or more validation checks failed

**Example output (text):**

```
Validation Complete
==================================================

Total Checks: 68
Passed: 68
Failed: 0
Duration: 60ms

Status: ✓ VALIDATION PASSED
```

### validate-claude

Validate Claude Code agent and skill format in `.claude/` directory.

```bash
# Validate all agents and skills
rhino-cli validate-claude

# Output as JSON
rhino-cli validate-claude -o json

# Verbose mode (show all checks)
rhino-cli validate-claude -v

# Validate only agents
rhino-cli validate-claude --agents-only

# Validate only skills
rhino-cli validate-claude --skills-only
```

**What it validates:**

**Agents (.claude/agents/):**

- YAML frontmatter syntax
- Required fields: name, description, tools, model, color, skills
- Field order (exact sequence required)
- Valid tool names (Read, Write, Edit, Glob, Grep, Bash, TodoWrite, WebFetch, WebSearch)
- Valid model names (empty, sonnet, opus, haiku)
- Valid colors (blue, green, yellow, purple)
- Filename matches name field
- Agent name uniqueness
- Skills references exist
- No YAML comments
- Special rules (e.g., generated-reports/ tools)

**Skills (.claude/skills/):**

- SKILL.md file exists
- Required field: description
- YAML syntax validity

**Flags:**

- `--agents-only` - Validate only agents (skip skills)
- `--skills-only` - Validate only skills (skip agents)
- `-o, --output` - Format: text, json, markdown
- `-v, --verbose` - Show all checks
- `-q, --quiet` - Summary only

**Exit codes:**

- `0` - All valid
- `1` - One or more invalid

**Example output (text):**

```
Validation Complete
==================================================

Total Checks: 513
Passed: 513
Failed: 0
Duration: 49ms

Status: ✓ VALIDATION PASSED
```

### doctor

Check that all required development tools are installed with the correct versions.
Reads version requirements from existing repository config files so it stays in sync automatically.

```bash
# Runs automatically after every npm install (postinstall hook)
npm install

# Or run manually from repo root
npm run doctor

# Or directly after building
rhino-cli doctor

# Output as JSON
rhino-cli doctor -o json

# Output as markdown report
rhino-cli doctor -o markdown

# Verbose output (includes duration)
rhino-cli doctor --verbose

# Quiet mode (suppresses header)
rhino-cli doctor --quiet
```

**What it does:**

- Checks 7 development tools: git, volta, node, npm, java, maven, golang
- Reads required versions dynamically from existing config files
- Reports each tool as: ✓ ok, ⚠ warning (wrong version), or ✗ missing (not in PATH)
- Only exits non-zero when a tool is missing; version warnings are advisory
- Supports multiple output formats (text, json, markdown)

**Tools checked:**

| Tool   | Binary  | Required Version Source                           | Comparison |
| ------ | ------- | ------------------------------------------------- | ---------- |
| git    | `git`   | (no config file — any version OK)                 | any        |
| volta  | `volta` | (no config file — any version OK)                 | any        |
| node   | `node`  | `package.json` → `volta.node`                     | exact      |
| npm    | `npm`   | `package.json` → `volta.npm`                      | exact      |
| java   | `java`  | `apps/organiclever-be/pom.xml` → `<java.version>` | major only |
| maven  | `mvn`   | (no config file — any version OK)                 | any        |
| golang | `go`    | `apps/rhino-cli/go.mod` → `go` directive          | ≥ (GTE)    |

**Flags:**

- `-o, --output` - Output format: text, json, markdown (default: text)
- `-v, --verbose` - Show duration after summary
- `-q, --quiet` - Suppress the "Doctor Report" header

**Exit codes:**

- `0` - All tools found (warnings about wrong versions are advisory, not failures)
- `1` - One or more tools not found in PATH

**Example output (text):**

```
Doctor Report
=============

✓ git        v2.47.2        (no version requirement)
✓ volta      v2.0.2         (no version requirement)
✓ node       v24.11.1       (required: 24.11.1)
✓ npm        v11.6.3        (required: 11.6.3)
✓ java       v25            (required: 25)
✓ maven      v3.9.9         (no version requirement)
✗ golang     not found      (required: ≥1.24.2)

Summary: 6/7 tools OK, 0 warning, 1 missing
```

**Example output (JSON):**

```json
{
  "status": "missing",
  "timestamp": "2026-02-19T10:00:00+07:00",
  "ok_count": 5,
  "warn_count": 0,
  "missing_count": 1,
  "duration_ms": 312,
  "tools": [
    {
      "name": "volta",
      "binary": "volta",
      "status": "ok",
      "installed_version": "2.0.2",
      "source": "(no config file)",
      "note": "no version requirement"
    }
  ]
}
```

## Help Commands

```bash
# General help
rhino-cli --help
rhino-cli help

# Command-specific help
rhino-cli validate-links --help

# Version
rhino-cli --version
```

## Architecture

```
apps/rhino-cli/
├── cmd/
│   ├── root.go               # Cobra root command, global flags
│   ├── root_test.go          # Tests for root command
│   ├── doctor.go             # Doctor command
│   ├── doctor_test.go        # Doctor command integration tests
│   ├── validate_links.go     # Link validation command
│   ├── validate_links_test.go # Integration tests
│   ├── sync_agents.go        # Agent/skill sync command
│   ├── validate_sync.go      # Sync validation command
│   └── validate_claude.go    # Claude Code format validation command
├── internal/
│   ├── doctor/               # Development environment checks
│   │   ├── types.go          # ToolStatus, ToolCheck, DoctorResult, CommandRunner types
│   │   ├── tools.go          # Tool definitions list — add new tools here
│   │   ├── checker.go        # Config readers, version parsers, comparators, runOneDef, CheckAll
│   │   ├── checker_test.go   # Unit tests for all parsers, comparisons, and checkers
│   │   ├── reporter.go       # Output formatting (text, JSON, markdown)
│   │   ├── reporter_test.go  # Reporter tests
│   │   └── testdata/         # Test fixtures (package.json, pom.xml, go.mod)
│   ├── links/                # Link validation logic
│   │   ├── types.go          # Core type definitions
│   │   ├── scanner.go        # Link extraction from markdown
│   │   ├── scanner_test.go
│   │   ├── validator.go      # Link validation logic
│   │   ├── validator_test.go
│   │   ├── categorizer.go    # Link categorization
│   │   ├── categorizer_test.go
│   │   ├── reporter.go       # Output formatting
│   │   └── reporter_test.go
│   ├── claude/               # Claude Code format validation
│   │   ├── types.go          # Data structures (ClaudeAgentFull, ClaudeSkill, constants)
│   │   ├── validator.go      # Main validation orchestration
│   │   ├── agent_validator.go # Agent validation (11 rules)
│   │   └── skill_validator.go # Skill validation (3 rules)
│   └── sync/                 # Agent/skill sync logic
│       ├── types.go          # Data structures (ClaudeAgent, OpenCodeAgent, etc.)
│       ├── types_test.go
│       ├── converter.go      # Claude → OpenCode conversion
│       ├── converter_test.go
│       ├── copier.go         # Skills copying
│       ├── copier_test.go
│       ├── validator.go      # Semantic validation
│       ├── validator_test.go
│       ├── reporter.go       # Output formatting
│       ├── sync.go           # Orchestration
│       └── testdata/         # Test fixtures
├── dist/                     # Built binary (gitignored)
├── main.go                   # CLI entry point
├── go.mod                    # Go module definition (includes gopkg.in/yaml.v3)
├── go.sum                    # Go module checksums
├── project.json              # Nx project configuration
└── README.md                 # Documentation
```

## Development

### Build

```bash
go build -o dist/rhino-cli
```

### Test

```bash
# Run all tests
go test ./...

# Run tests with coverage
go test ./... -cover

# Run tests with verbose output
go test ./... -v
```

**Test Coverage:**

- `cmd`: Root command tests, validate-links integration tests, doctor integration tests
- `internal/doctor`: 95%+ coverage (checker, reporter — all pure functions tested with fake runner)
- `internal/links`: 85%+ coverage (scanner, validator, categorizer, reporter)
- `internal/sync`: 85%+ coverage (converter, copier, validator, reporter)
- `internal/claude`: 92.6% coverage (validator, agent_validator, skill_validator)

### Run without building

```bash
go run main.go say "hello"
```

## Nx Integration

The CLI is integrated into the Nx workspace:

```bash
# Build via Nx
nx build rhino-cli

# Run unit tests via Nx
nx test:quick rhino-cli

# Run via Nx
nx run rhino-cli

# Install dependencies via Nx
nx install rhino-cli
```

**Available Nx Targets:**

- `build` - Build the CLI binary to `dist/`
- `test:quick` - Run unit tests (`go test ./...`)
- `run` - Run the CLI directly (`go run main.go`)
- `install` - Install Go dependencies (`go mod tidy`)

## Testing

The project includes comprehensive unit tests:

### Test Suite

**Doctor Tests (`cmd/doctor_test.go`, `internal/doctor/`):**

- Command initialization (Use, Short)
- Text output contains "Doctor Report" and all 6 tool names
- JSON output is valid with correct structure and "tools" array
- Markdown output contains `| Tool |` table
- Missing git root returns error mentioning "git"
- All version parsers (Java, Maven, Go) with multiple real-world patterns
- All comparison helpers (exact, major) with match/mismatch/empty cases
- All 6 individual checkers with fake runner (found/mismatch/missing)
- `CheckAll` orchestration with all-OK and all-missing runner
- Config file readers (package.json, pom.xml, go.mod) with valid/invalid/missing inputs

**Root Command Tests (`cmd/root_test.go`):**

- Command initialization
- Global flags parsing (--verbose, --quiet, --output, --no-color, --say)
- Version output
- Say flag functionality (basic output, multiple words, empty message)
- Say flag with verbose mode (timestamps)
- Say flag with quiet mode
- Say flag with combined flags
- Say flag special characters handling
- Say flag long message handling

### Running Tests

```bash
# Run all tests
go test ./... -v

# Run tests with coverage
go test ./... -coverprofile=coverage.out

# View coverage report
go tool cover -html=coverage.out
```

## Say Flag Behavior

**Basic usage:**

```bash
rhino-cli --say "hello world"
# Output: hello world
```

**With verbose flag:**

```bash
rhino-cli --say "hello" --verbose
# Output: [2026-01-05 14:30:00] INFO: Executing say command
#         [2026-01-05 14:30:00] INFO: Message: hello
#         hello
```

**With quiet flag:**

```bash
rhino-cli --say "hello" --quiet
# Output: hello
```

**With verbose flag:**

```bash
rhino-cli say "hello" --verbose
# Output: [2025-01-05 12:00:00] INFO: Executing say command
#         [2025-01-05 12:00:00] INFO: Message: hello
#         hello
```

**With quiet flag:**

```bash
rhino-cli say "hello" --quiet
# Output: hello
```

**Error case:**

```bash
rhino-cli say
# Output: Error: requires at least 1 arg(s), only received 0
```

## Version History

### v0.5.0 (2026-02-19)

- Added `doctor` command for development environment verification
- Checks 6 tools: volta, node, npm, java, maven, golang
- Reads required versions from package.json, pom.xml, and go.mod dynamically
- Injectable `CommandRunner` for hermetic unit testing (no subprocess spawning)
- Three output formats: text, JSON, markdown
- Distinguishes missing tools (exit 1) from version warnings (advisory only)
- 95%+ test coverage with 55+ tests across checker and reporter packages

### v0.4.0 (2026-01-22)

- Added `validate-claude` command for Claude Code format validation
- YAML frontmatter validation (11 rules for agents, 3 for skills)
- Integrated into pre-commit git hook with work avoidance
- Performance: ~49ms for 45 agents + 21 skills (meets <50ms target)
- Auto-sync .claude/ to .opencode/ on pre-commit
- Comprehensive test suite with 92.6% coverage

### v0.3.0 (2026-01-22)

- Added `sync-agents` command for syncing Claude Code → OpenCode formats
- Added `validate-sync` command for validating semantic equivalence
- YAML frontmatter conversion (tools, model mapping, normalization)
- 25-60x performance improvement over bash scripts (121ms vs 3-5s)
- Comprehensive test suite (85%+ coverage for sync logic)
- Replaces `scripts/sync-claude-to-opencode.sh` and `scripts/validate-sync.sh`
- Added dependency: gopkg.in/yaml.v3

### v0.2.0 (2026-01-21)

- Added `validate-links` command for markdown link validation
- Ported from Python to Go for better performance and maintainability
- Comprehensive test suite (85%+ coverage for link validation)
- Multiple output formats (text, JSON, markdown)
- Staged-only mode for git hooks
- Replaces `scripts/validate-links.py`

### v0.1.0 (2026-01-05)

- Initial release
- `--say` global flag for echoing messages
- Global flags: --verbose, --quiet, --output, --no-color
- Nx integration
- Comprehensive unit tests (100% coverage)
