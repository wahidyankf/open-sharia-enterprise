# Local Development Environment for OrganicLever
# Backend: Spring Boot with auto-reload via Spring Boot DevTools
# Frontend: Next.js dev server

services:
  organiclever-be:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: organiclever-be
    working_dir: /workspace

    # Mount full source code for development
    volumes:
      - ../../../apps/organiclever-be:/workspace:rw

    ports:
      - "8201:8201"

    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8201
      - MAVEN_OPTS=${MAVEN_OPTS:--Xmx512m}

    # Run Spring Boot with DevTools for auto-reload
    # Maven is pre-installed in the custom dev image (see Dockerfile.dev)
    command: mvn spring-boot:run -Dspring-boot.run.profiles=dev

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8201/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s # Extended for Maven dependency download on first run

    restart: unless-stopped
    networks:
      - organiclever-network

  organiclever-web:
    build:
      context: .
      dockerfile: Dockerfile.web.dev
    container_name: organiclever-web
    working_dir: /workspace

    volumes:
      - ../../../apps/organiclever-web:/workspace:rw
      - organiclever-web-node-modules:/workspace/node_modules

    ports:
      - "3200:3200"

    environment:
      - NODE_ENV=development
      - PORT=3200
      # START_COMMAND controls startup behaviour (default: dev).
      # Set START_COMMAND=production in the host environment to run a
      # production build instead (used by CI to get pre-compiled pages).
      - START_COMMAND=${START_COMMAND:-dev}

    # Install deps on start, then launch in the selected mode:
    #   (default)                → npm install + next dev (hot-reload, for local dev)
    #   START_COMMAND=production → npm install --omit=dev + next start
    #                              CI only: host runs nx build first; container just
    #                              serves the pre-built .next/ from the bind mount.
    #                              --omit=dev skips Storybook/vitest (saves ~5 min).
    command: >-
      sh -c "if [ \"$$START_COMMAND\" = \"production\" ];
             then npm install --omit=dev && npm run start;
             else npm install && npm run dev;
             fi"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3200"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s # Extended for cold npm install (Storybook devDeps are heavy)

    restart: unless-stopped
    networks:
      - organiclever-network

networks:
  organiclever-network:
    driver: bridge
    name: organiclever-network

volumes:
  organiclever-web-node-modules:
