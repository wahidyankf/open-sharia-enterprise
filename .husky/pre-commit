# 1. Validate .claude/ and .opencode/ config (if affected)
if git diff --cached --name-only | grep -qE '^\.claude/|^\.opencode/'; then
  echo "üîç Validating .claude/ and .opencode/ configuration..."
  npm run validate:config || {
    echo "‚ùå Configuration validation failed. Fix errors above before committing."
    exit 1
  }
  echo "‚úÖ Configuration validation passed"
else
  echo "‚è≠Ô∏è  Skipping config validation (no .claude/ or .opencode/ changes in staged files)"
fi

# 2. Run ayokoding-web pre-commit scripts if affected (titles update + nav regen)
nx affected -t run-pre-commit --skip-nx-cache 2>/dev/null || echo "‚ö†Ô∏è  Skipping run-pre-commit (not affected or binary missing)"

# 3. Stage any changes made by the scripts
git add apps/ayokoding-web/content/ 2>/dev/null || true

# 4. Run lint-staged for formatting
npx lint-staged

# 5. Validate and auto-fix docs file naming conventions (if docs/ affected)
if git diff --cached --name-only | grep -qE '^docs/'; then
  echo "üîç Validating and fixing documentation file naming..."
  CGO_ENABLED=0 go run -C apps/rhino-cli main.go validate-docs-naming --staged-only --fix --apply || exit 1
  # Stage any files modified by link updates and renames
  git add docs/ governance/ .claude/ 2>/dev/null || true
  echo "‚úÖ Documentation naming validation passed"
else
  echo "‚è≠Ô∏è  Skipping docs naming validation (no docs/ changes in staged files)"
fi

# 6. Validate markdown links in staged files
CGO_ENABLED=0 go run -C apps/rhino-cli main.go validate-links --staged-only || exit 1

# 7. Validate all markdown files
npm run lint:md || exit 1
