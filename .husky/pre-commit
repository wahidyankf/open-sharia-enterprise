# 1. Validate .claude/ and .opencode/ config (if affected)
if git diff --cached --name-only | grep -qE '^\.claude/|^\.opencode/'; then
  echo "üîç Validating .claude/ and .opencode/ configuration..."
  npm run validate:config || {
    echo "‚ùå Configuration validation failed. Fix errors above before committing."
    exit 1
  }
  echo "‚úÖ Configuration validation passed"
else
  echo "‚è≠Ô∏è  Skipping config validation (no .claude/ or .opencode/ changes in staged files)"
fi

# 2. Validate docker-compose.yml files (if affected)
if git diff --cached --name-only | grep -qE 'docker-compose\.ya?ml$'; then
  echo "üîç Validating docker-compose.yml files..."

  # Find all staged docker-compose files
  for compose_file in $(git diff --cached --name-only | grep -E 'docker-compose\.ya?ml$'); do
    if [ -f "$compose_file" ]; then
      echo "  Checking $compose_file..."

      # Validate YAML syntax and docker-compose config
      if ! docker-compose -f "$compose_file" config > /dev/null 2>&1; then
        echo "‚ùå Docker Compose validation failed for $compose_file"
        echo "   Run: docker-compose -f $compose_file config"
        exit 1
      fi

      echo "  ‚úÖ $compose_file is valid"
    fi
  done

  echo "‚úÖ All docker-compose files validated"
else
  echo "‚è≠Ô∏è  Skipping docker-compose validation (no docker-compose.yml changes in staged files)"
fi

# 3. Run ayokoding-web pre-commit scripts if affected (titles update + nav regen)
nx affected -t run-pre-commit --skip-nx-cache 2>/dev/null || echo "‚ö†Ô∏è  Skipping run-pre-commit (not affected or binary missing)"

# 4. Stage any changes made by the scripts
git add apps/ayokoding-web/content/ 2>/dev/null || true

# 5. Run lint-staged for formatting
npx lint-staged

# 6. Validate and auto-fix docs file naming conventions (if docs/ affected)
if git diff --cached --name-only | grep -qE '^docs/'; then
  echo "üîç Validating and fixing documentation file naming..."
  CGO_ENABLED=0 go run -C apps/rhino-cli main.go validate-docs-naming --staged-only --fix --apply || exit 1
  # Stage any files modified by link updates and renames
  git add docs/ governance/ .claude/ 2>/dev/null || true
  echo "‚úÖ Documentation naming validation passed"
else
  echo "‚è≠Ô∏è  Skipping docs naming validation (no docs/ changes in staged files)"
fi

# 7. Validate markdown links in staged files
CGO_ENABLED=0 go run -C apps/rhino-cli main.go validate-links --staged-only || exit 1

# 8. Validate all markdown files
npm run lint:md || exit 1
